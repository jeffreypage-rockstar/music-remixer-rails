<%- title("#{@song.name}") %>
<% @currentIndex = 1 %>
<!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
mixpanel.init("a81950f98fc6136b7a5ca4f55db5b8bc");</script><!-- end Mixpanel -->
<style>
	.section {
		padding: 15px 0;
	}
	.configure {
          overflow-x: hidden;
    }
</style>
<div id="wrapper" class="toggled clearfix">
	<div id="page-content-wrapper">
		<div class="section section-shadow section-white">
			<div id="tracker-head" class="container-fluid">
				<div class="clearfix">
					<a href="#" class="pull-right" style="margin-top: 10px" data-toggle="sidebar">Mobile Preview &raquo;</a>
					<h3 class="pull-left editable-text songtitle"><span><%=@song.name%></span></h3>
					<div id="release-status" data-status="<%= @song.status.to_s %>" class="<%= @song.status.to_s %>">
						<% if (@song.released?) %>
							UNRELEASE
						<% else %>
							RELEASE
						<% end %>
					</div>
					<div id="release-progress" style="margin-top: 10px;float: right;margin-right:10px;text-align: center;vertical-align: middle;font-weight: bold;">	
					 
					 <%= @song.released? ? "SONG STATUS:RELEASED" : "SONG STATUS:WORKING" %>
					 
				</div>
				</div>
				<div id="mixaudioplayer" class="row container-fluid main-player-area">
					<%= render 'mixaudioplayer', song: @song, mixaudio: @mixaudio %>
				</div>
			</div>
		</div>
	</div>
	<div id="page-content-wrapper">
		<div id="song-clips" data-id="<%=@song.id%>" style="display:none"></div>
		<div id="tracker-desktop" class="section">
			<div id="mix-tabs" class="container">
				<h5 class="tab active"><a href="#" data-id="<%= current_user.name %>" data-mix="original">Original</a></h5>
				<h5 class="tab"><a href="#" data-id="<%= current_user.name %>" data-mix="mix2">Mix2</a></h5>
                <h5 class="tab"><a href="#" data-id="<%= current_user.name %>" data-mix="mix3">Mix3</a></h5>
                <h5 class="bmp_margin" style="margin:0 auto; float:left"> <label href="#" data-mix="mix3" style="font-weight: bolder;position: relative;padding: 15px 5px 15px 20px;float: left;margin: 0px 0px 0px 0px; float:right;">BPM :</label></h5>
                 	<h5 style="margin:0 auto ;  float	:left" class="bpm" >	              
	                	<span><%=@song.bpm%></span>
	            	</h5>
				<div id="tracker-mixer" class="shadow">
					<div class="mixer-row">
						<div class="clearfix">
							<%= render 'clips/index' %>
						</div>
					</div>
				</div>
				<div id="sidebar-wrapper"><div id="preview">
					<%= render 'preview' %>
				</div></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

$(".tab a").click(function(){
	var textInner=$(this).text();	
	var user_name=$(this).data('id');
	
  	mixpanel.track(
    textInner+" configured by "+ user_name,
    {"genre": "hip-hop"});
});


$('.bpm').on('click',
			'span',
			function(e) {	
				var topparent = $($(e.target).parent());
				var classnm=$(e.target).text();
	
				$($(e.target).parent()).html('<input class="bpm_input" type="number" data-originalvalue="' + $(e.target).text() + '" value="' + $(e.target).text() + '">')
						.on('blur keyup',
						'input',
						function(e) {
							if (e.type == 'keyup') {
								var key = e.keyCode || e.which;
								if (key == 13 || 0) {
									$(this).blur();
								}
								return;
							}



							var parent = $(e.target).parent();
							e.stopPropagation();
							$($(e.target).parent()).html('<span>' + $(e.target).val() + '</span>');

							
							if (parent.hasClass("bpm")) {
								url = '/songs/' + <%=@song.id%>;
							}
							// console.log(url);

							$.ajax({
								type: "PUT",
								dataType: "json",
								url: url,
								contentType: 'application/json',
								data: JSON.stringify({bpm: $(e.target).val() })
							})
									.done(function( msg ) {
										console.log( "Data Saved: " + msg );
									})
									.fail(function( msg ) {
										console.log(  msg );
									});
						});
				topparent.children('input')[0].focus();
				var tmpStr = $(topparent.children('input')[0]).val();
				$(topparent.children('input')[0]).val('');
				$(topparent.children('input')[0]).val(tmpStr);
			});	
    $(window).keypress(function(e) {
        if ($('#mixaudioplayer').length > 0) {
            if (e.keyCode == 0 || e.keyCode == 32) {
                e.preventDefault();
                playOrPauseTopWavesurferPlayer();
            }
        }
    });

    window.configuration = "<%=@configuration%>";
    initializeTopPlayer = function(mixedFilePath) {
        window.topWavesurfer = Object.create(WaveSurfer);
        window.topWavesurfer.init({
            container: '.full-waveform',
            fillParent: true,
            height: 34,
            waveColor: 'white',
            progressColor: 'white',
            cursorColor: 'white'
        });
        window.topWavesurfer.on('ready', function (_this) {
            console.log("Mix Audio player is ready!");
            $(".full-play-btn, #mixaudio").removeClass('disabled');
        });

        window.topWavesurfer.on('loading', function (_this, progress) {
            $(_this.container).children(".progress").css("left", progress+"%");
        });

        window.topWavesurfer.on('finish', function () {
            updatePreviewPlayBtn(false);
            $(".full-play-btn").removeClass('playing');
            window.topWavesurfer.seekTo(0);
        });
        window.topWavesurfer.load(mixedFilePath);
    }

    stopTopPlayer = function() {
        if (window.topWavesurfer) {
            if (window.topWavesurfer.backend && !window.topWavesurfer.backend.isPaused()) {
                window.topWavesurfer.pause();
                $(".full-play-btn").removeClass('playing');
            }
        }
    }

    $(document).ready(function(){
		var progress = $("#tracker-compiled").data("progress");
		var parts = $("#tracker-compiled .tracker-part").length;
		var updateProgress = function(progress, parts) {
			var step = 100 / parts;
			var current = 1;
			var i;
			for ( i = step; i <= progress; i += step ) {
				$("#tracker-compiled .tracker-part.part" + current + " .gradient").css("width", "100%");
				$("#tracker-compiled .tracker-part.part" + current + " .gradient").css("outline-width", "2px");
				current ++;
			}
			var fill = (progress % step) * 100 / step;
			$("#tracker-compiled .tracker-part.part" + current + " .gradient").css("width", fill + "%");
			$("#tracker-compiled .tracker-part.part" + current + " .gradient").css("outline-width", "2px");
		}

		/* Mobile Version Toggle */
		$("a[data-toggle='sidebar']").click(function(e) {
			e.preventDefault();
			$("#wrapper").toggleClass("toggled");
		});

        $('#release-status').on('click', function(e) {
			// debugger;
            if($(e.target).attr("data-status") == "pending") {
                $.ajax({
                    type: "PUT",
                    dataType: "json",
                    url: '/songs/<%=@song.id%>',
                    contentType: 'application/json',
                    data: JSON.stringify({status: "released"})
                })
				.done(function( msg ) {
					console.log( "Data Saved: " + msg );
					$(e.target).attr("data-status","released");
					$(e.target).attr("class","released");
					$('#release-progress').html('SONG STATUS:RELEASED');
					$(e.target).html('UNRELEASE');
					
					// $(e.target).html('Released').css('background', 'green')
					// $(e.target).html('Released').css('background', 'green')
				})
				.fail(function( msg ) {
					console.log(  msg );
				});
            }
            else{
            		$.ajax({
	                    type: "PUT",
	                    dataType: "json",
	                    url: '/songs/<%=@song.id%>',
	                    contentType: 'application/json',
	                    data: JSON.stringify({status: "pending"})
                	})
					.done(function( msg ) {
						console.log( "Data Saved: " + msg );
						$(e.target).attr("data-status","pending");
						$(e.target).attr("class","pending");
						$('#release-progress').html('SONG STATUS:WORKING');
						$(e.target).html('RELEASE');
						// $(e.target).html('Released').css('background', 'green')
					})
					.fail(function( msg ) {
						console.log(  msg );
					});
            	}
        });

        $('#mix-tabs .tab a').click(function (event) {
            event.preventDefault();
            $('#mix-tabs .tab').removeClass('active');
            $(this).closest('.tab').addClass('active');
            window.configuration = $(this).data('mix');
            reInitializeClipsState();
            updatePreview();
            window.configurationBtn = this;
        });
    });

    </script>